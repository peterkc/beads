# Implementation Plan: bdx Migration

Detailed execution plan for the 3-stage migration. See [ADR 0003](../adr/0003-migration-strategy-strangler-fig.md) for strategy.

## Stage 1: Foundation

**Goal:** Establish safety net and contracts before structural changes.

**Duration:** 7-12 days

### 1a. Testing Infrastructure (1-2 days)

**New dependencies:**

```go
// go.mod additions
require (
    github.com/stretchr/testify v1.9.0
    go.uber.org/mock v0.5.0
    pgregory.net/rapid v1.2.0
)
```

**New files:**

```
internal/testutil/
├── fixtures.go        # Test data generators
├── assertions.go      # Custom assertions
└── db.go              # In-memory SQLite helper

Makefile additions:
    test-unit, test-integration, test-e2e targets
```

### 1b. Characterization Tests (3-5 days)

**Goal:** Capture v0 behavior as executable specifications.

**New files:**

```
characterization/
├── create_test.go         # Create behavior
├── list_test.go           # List/search behavior
├── update_test.go         # Update behavior
├── dependency_test.go     # Dependency behavior
├── sync_test.go           # Sync behavior
└── helpers_test.go        # Shared setup
```

**Example:**

```go
//go:build characterization

func TestCreate_V0Behavior(t *testing.T) {
    store := setupV0Store(t)

    tests := []struct {
        name     string
        input    types.Issue
        validate func(*testing.T, *types.Issue)
    }{
        {
            name:  "priority defaults to 2",
            input: types.Issue{Title: "Test"},
            validate: func(t *testing.T, got *types.Issue) {
                assert.Equal(t, 2, got.Priority)
            },
        },
        // ... capture ALL behaviors
    }
}
```

### 1c. Core Domain Layer (2-3 days)

**Goal:** Pure Go domain with zero external dependencies.

**New files:**

```
internal/next/core/
├── issue/
│   ├── issue.go           # Issue entity
│   ├── status.go          # Status enum
│   └── priority.go        # Priority enum
├── dependency/
│   ├── dependency.go      # Dependency entity
│   └── graph.go           # Graph algorithms
├── label/
│   └── label.go           # Label value object
└── events/
    ├── event.go           # Domain events
    └── types.go           # Event type enum
```

**Rule:** `internal/next/core/` has ZERO imports from outside `core/`.

### 1d. Ports / Interfaces (1-2 days)

**Goal:** Define contracts before implementation.

**New files:**

```
internal/next/ports/
├── repositories/
│   ├── issue.go           # IssueRepository (5 methods)
│   ├── dependency.go      # DependencyRepository (4 methods)
│   ├── label.go           # LabelRepository (3 methods)
│   ├── comment.go         # CommentRepository (3 methods)
│   ├── config.go          # ConfigRepository (3 methods)
│   └── sync.go            # SyncRepository (4 methods)
├── services/
│   ├── linear.go          # LinearService
│   └── git.go             # GitService
└── events/
    └── bus.go             # EventBus interface

internal/mocks/               # Generated by mockgen
├── issue_repo_mock.go
├── dependency_repo_mock.go
└── ...
```

### Stage 1 Checkpoint

```
✅ Testing infrastructure (testify, gomock, rapid)
✅ Characterization tests (v0 behavior captured)
✅ Core domain (pure Go, fully tested)
✅ Port interfaces (contracts defined)
✅ Generated mocks (ready for use case tests)
```

**Validation gate:**

```bash
go test -tags=characterization ./characterization/...  # 100% pass
go test ./internal/next/core/...                       # 100% pass
go generate ./internal/next/ports/...                  # Mocks generate
```

______________________________________________________________________

## Stage 2: Pluginize

**Goal:** Wrap v0 code in plugin architecture (same behavior, new structure).

**Duration:** 5-7 days

### 2a. Plugin Infrastructure

**New files:**

```
internal/next/plugins/
├── plugin.go              # Plugin interface
├── context.go             # PluginContext (wraps v0 Storage)
└── registry.go            # Command routing
```

**PluginContext wraps v0:**

```go
// internal/next/plugins/context.go
type Context struct {
    Storage *storage.Storage  // v0: wraps existing 75-method interface
}

func NewContext(db *sql.DB) *Context {
    return &Context{
        Storage: storage.New(db),  // existing v0 code
    }
}
```

### 2b. Plugin Implementations

**New files:**

```
internal/next/plugins/
├── core/                  # create, list, show, update, close
│   ├── plugin.go
│   ├── create.go
│   ├── list.go
│   └── ...
├── work/                  # ready, dep, blocked
│   └── plugin.go
├── sync/                  # sync, export, import
│   └── plugin.go
├── linear/                # Linear integration
│   └── plugin.go
├── molecules/             # Molecules integration
│   └── plugin.go
└── compact/               # Compact integration
    └── plugin.go
```

**Example wrapper:**

```go
// internal/next/plugins/core/create.go
func (p *Plugin) Create(ctx *plugins.Context, args []string) error {
    title, description, priority := parseArgs(args)

    // Delegate to existing v0 code
    issue, err := ctx.Storage.CreateIssue(title, description, priority)
    if err != nil {
        return err
    }

    fmt.Printf("Created: %s\n", issue.ID)
    return nil
}
```

### 2c. Wire Main Entry Point

**New file:** `cmd/bdx/main.go`

```go
func main() {
    registry := plugins.NewRegistry()

    // All plugins wrap existing v0 code
    registry.Register(core.Plugin{})
    registry.Register(work.Plugin{})
    registry.Register(sync.Plugin{})
    registry.Register(linear.Plugin{})
    registry.Register(molecules.Plugin{})
    registry.Register(compact.Plugin{})

    ctx := plugins.NewContext(openDB())

    if err := registry.Execute(os.Args[1], ctx, os.Args[2:]); err != nil {
        fmt.Fprintln(os.Stderr, err)
        os.Exit(1)
    }
}
```

### Stage 2 Checkpoint

```
✅ Plugin infrastructure
✅ All command plugins (core, work, sync, linear, molecules, compact)
✅ Main entry point rewired
✅ bdx works identically to bd
```

**Validation gate:**

```bash
# All characterization tests still pass
go test -tags=characterization ./characterization/...

# bdx produces same output as bd
./scripts/compare-bd-bdx.sh
```

______________________________________________________________________

## Stage 3: Modernize

**Goal:** Replace v0 internals with v1 architecture.

**Duration:** 7-10 days

### 3a. Adapters (v1 implementations)

**New files:**

```
internal/next/adapters/sqlite/
├── issue_repo.go
├── dependency_repo.go
├── work_repo.go
├── config_store.go
├── sync_tracker.go
└── row_mapper.go          # DRY helper
```

### 3b. Use Cases

**New files:**

```
internal/next/usecases/
├── issue/
│   ├── create.go
│   ├── update.go
│   └── close.go
├── dependency/
│   ├── add.go
│   └── remove.go
└── sync/
    ├── export.go
    └── import.go
```

### 3c. Update PluginContext to v1 Ports

**Before (Stage 2):**

```go
type Context struct {
    Storage *storage.Storage  // v0
}
```

**After (Stage 3):**

```go
type Context struct {
    Issues       ports.IssueRepository
    Dependencies ports.DependencyRepository
    Work         ports.WorkRepository
    Config       ports.ConfigStore
    Sync         ports.SyncTracker
    Events       ports.EventBus
}
```

### 3d. Validation & Cleanup

**Before cleanup, confirm:**

- [ ] All characterization tests pass
- [ ] Performance benchmarks acceptable
- [ ] No regressions in user workflows
- [ ] Stakeholder sign-off

**Cleanup:**

```bash
rm -rf internal/v0/
```

### Stage 3 Checkpoint

```
✅ v1 adapters implemented
✅ Use cases implemented
✅ Plugins use v1 ports
✅ Characterization tests pass
✅ v0 code deleted
```

______________________________________________________________________

## File Count Summary

| Stage         | New Files | Modified | Deleted | Duration  |
| ------------- | --------- | -------- | ------- | --------- |
| 1: Foundation | ~29       | 2        | 0       | 7-12 days |
| 2: Pluginize  | ~20       | 1        | 0       | 5-7 days  |
| 3: Modernize  | ~14       | ~20      | ~30     | 7-10 days |

**Grand Total:** ~63 new, ~23 modified, ~30 deleted, 19-29 days

______________________________________________________________________

## File Mapping: v0 → v1

| v0 (internal/v0/)                | v1 (internal/next/)                  |
| -------------------------------- | ------------------------------------ |
| `storage/storage.go`             | `ports/*.go`                         |
| `storage/sqlite/queries.go`      | `adapters/sqlite/issue_repo.go`      |
| `storage/sqlite/dependencies.go` | `adapters/sqlite/dependency_repo.go` |
| `storage/sqlite/ready.go`        | `adapters/sqlite/work_repo.go`       |
| `storage/sqlite/config.go`       | `adapters/sqlite/config_store.go`    |
| `storage/sqlite/dirty.go`        | `adapters/sqlite/sync_tracker.go`    |
| `rpc/server_*.go`                | `usecases/*.go`                      |
| `linear/`                        | `plugins/linear/`                    |
| `compact/`                       | `plugins/compact/`                   |
| `molecules/`                     | `plugins/molecules/`                 |
