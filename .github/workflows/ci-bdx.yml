name: CI (bdx)

on:
  push:
    branches: [main]
    tags: ['v1.*']
    paths:
      - 'cmd/**'
      - 'internal/**'
      - 'go.mod'
      - 'go.sum'
      - 'Justfile'
      - 'scripts/**'
      - '.github/workflows/ci-bdx.yml'
  pull_request:
    branches: [main]
    paths:
      - 'cmd/**'
      - 'internal/**'
      - 'go.mod'
      - 'go.sum'
      - 'Justfile'
      - 'scripts/**'
      - '.github/workflows/ci-bdx.yml'

env:
  GO_VERSION: '1.24'

jobs:
  # Fast checks run first and in parallel
  fast-checks:
    name: Fast Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check version consistency
        run: ./scripts/check-versions.sh

      - name: Check for .beads changes (PRs only)
        if: github.event_name == 'pull_request'
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "^\.beads/issues\.jsonl$"; then
            echo "::error::PR includes .beads/issues.jsonl changes. Run: git checkout origin/main -- .beads/issues.jsonl"
            exit 1
          fi

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --timeout=5m

  # Build both binaries
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build bd
        run: go build -v -o bd ./cmd/bd

      - name: Build bdx
        run: go build -v -o bdx ./cmd/bdx

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-linux
          path: |
            bd
            bdx
          retention-days: 1

  # Characterization tests - MUST pass (v0 behavior preserved)
  test-characterization:
    name: Characterization Tests
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Configure Git
        run: |
          git config --global user.name "CI Bot"
          git config --global user.email "ci@beads.test"

      - name: Run characterization tests
        run: go test -v -run "TestCharacterization" ./...

  # Main test suite
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [fast-checks, lint]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            coverage: true
            test-flags: '-v -race -short -coverprofile=coverage.out'
          - os: macos-latest
            coverage: false
            test-flags: '-v -race -short'
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Configure Git
        run: |
          git config --global user.name "CI Bot"
          git config --global user.email "ci@beads.test"

      - name: Test
        run: go test ${{ matrix.test-flags }} ./...

      - name: Check coverage threshold
        if: matrix.coverage
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 42" | bc -l) )); then
            echo "::error::Coverage $COVERAGE% is below 42% threshold"
            exit 1
          fi

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: matrix.coverage && success()
        with:
          file: ./coverage.out
          fail_ci_if_error: false

  # v1-specific tests (when they exist)
  test-v1:
    name: Test v1 Domain
    runs-on: ubuntu-latest
    needs: [test-characterization]
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Configure Git
        run: |
          git config --global user.name "CI Bot"
          git config --global user.email "ci@beads.test"

      - name: Test v1 packages
        run: |
          # Run tests for v1 packages when they exist
          if [ -d "internal/domain" ]; then
            go test -v ./internal/domain/...
          fi
          if [ -d "internal/ports" ]; then
            go test -v ./internal/ports/...
          fi
          if [ -d "internal/adapters" ]; then
            go test -v ./internal/adapters/...
          fi
          echo "v1 package tests complete (or skipped if packages don't exist yet)"

  # Stage validation (runs on main only)
  stage-gate:
    name: Stage Gate
    runs-on: ubuntu-latest
    needs: [test, test-characterization, test-v1]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Configure Git
        run: |
          git config --global user.name "CI Bot"
          git config --global user.email "ci@beads.test"

      - name: Run stage checkpoint
        run: |
          # Determine current stage from CLAUDE.md or default to stage1
          if grep -q "Stage 2" CLAUDE.md 2>/dev/null; then
            just check-stage2
          else
            just check-stage1
          fi
